<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Secure Flask Feedback Application" />
    <title>{% block title %}Feedback App{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link
      href="{{ url_for('static', filename='css/style.css') }}"
      rel="stylesheet"
    />

    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <!-- Navigation -->
    <nav
      class="navbar navbar-expand-lg navbar-modern"
      aria-label="Main navigation"
    >
      <div class="container">
        <a
          class="navbar-brand navbar-brand-modern"
          href="{{ url_for('main.index') }}"
          aria-label="Home"
        >
          <i class="bi bi-chat-dots"></i> Feedback App
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('main.index') }}"
                aria-label="Home page"
              >
                <i class="bi bi-house"></i> Home
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('main.about') }}"
                aria-label="About page"
              >
                <i class="bi bi-info-circle"></i> About
              </a>
            </li>
          </ul>

          <ul class="navbar-nav" id="auth-nav">
            <!-- Auth navigation will be populated by JavaScript -->
          </ul>

          <!-- Notification Dropdown (for admin users) -->
          <div
            class="navbar-nav ms-2"
            id="notification-dropdown-container"
            style="display: none"
          >
            {% include 'components/notification_dropdown.html' %}
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-4" role="main">
      <!-- Flash Messages -->
      <div id="flash-messages"></div>

      <!-- Page Content -->
      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer
      class="py-4 mt-5"
      role="contentinfo"
      style="
        background-color: var(--bg-secondary);
        border-top: 1px solid var(--border-primary);
      "
    >
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <p class="mb-0" style="color: var(--text-secondary)">
              &copy; 2025 Feedback App. All rights reserved.
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <p class="mb-0">
              <a
                href="{{ url_for('main.about') }}"
                class="text-decoration-none"
                style="color: var(--text-secondary)"
                >About</a
              >
              |
              <a
                href="#"
                class="text-decoration-none"
                style="color: var(--text-secondary)"
                >Privacy</a
              >
              |
              <a
                href="#"
                class="text-decoration-none"
                style="color: var(--text-secondary)"
                >Terms</a
              >
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Socket.IO Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    {% block extra_js %}{% endblock %}

    <script>
      // Global Socket.IO instance
      let socket = null;

      // Test if scripts are loading
      console.log("Base template script loaded");
      console.log("App available:", typeof App);
      console.log("Auth available:", typeof Auth);

      // Initialize app when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, initializing apps...");

        // Initialize App first
        if (typeof App !== "undefined") {
          console.log("Initializing App...");
          App.init();
        } else {
          console.log("App not found!");
        }

        // Initialize Auth after a short delay to ensure everything is loaded
        setTimeout(() => {
          console.log("Timeout reached, checking Auth...");

          if (typeof Auth !== "undefined") {
            console.log("Initializing Auth...");
            Auth.init();
          } else {
            console.log("Auth not found! Check if auth.js is loaded properly.");
            console.log(
              "Available global objects:",
              Object.keys(window).filter(
                (key) => key.includes("Auth") || key.includes("App")
              )
            );
          }

          // Initialize notification system
          console.log("About to initialize notification system...");
          initNotificationSystem();
        }, 200);
      });

      // Notification System Functions
      function initNotificationSystem() {
        console.log("Initializing notification system...");
        // Check if user is authenticated and is admin
        if (typeof Auth !== "undefined" && Auth.isAuthenticated()) {
          // Check if user is admin before showing notification dropdown
          checkUserRoleAndShowNotifications();
        }
      }

      async function checkUserRoleAndShowNotifications() {
        try {
          console.log("Checking user role for notifications...");
          const response = await fetch("/auth/me", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            console.log("User data:", data);
            if (data.user && data.user.role === "admin") {
              console.log("User is admin, showing notification dropdown");
              showNotificationDropdown();
              loadNotificationCount();
              loadNotifications();
              initializeSocketIO();
              // Store admin status to prevent interference
              window.isAdminUser = true;
            } else {
              console.log("User is not admin, hiding notification dropdown");
              hideNotificationDropdown();
              window.isAdminUser = false;
            }
          } else {
            console.log("Failed to get user data, status:", response.status);
          }
        } catch (error) {
          console.error("Failed to check user role:", error);
          hideNotificationDropdown();
        }
      }

      function showNotificationDropdown() {
        const container = document.getElementById(
          "notification-dropdown-container"
        );
        if (container) {
          container.style.display = "block";
          console.log("Notification dropdown shown");
        } else {
          console.log("Notification dropdown container not found!");
        }
      }

      function hideNotificationDropdown() {
        // Don't hide if user is admin
        if (window.isAdminUser) {
          console.log("Not hiding notification dropdown - user is admin");
          return;
        }

        const container = document.getElementById(
          "notification-dropdown-container"
        );
        if (container) {
          container.style.display = "none";
          console.log("Notification dropdown hidden");
        }
      }

      async function loadNotificationCount() {
        try {
          const response = await fetch("/api/notifications/count", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            if (data.is_admin) {
              updateNotificationBadge(data.unread_count);
            } else {
              // Non-admin users don't see notification count
              updateNotificationBadge(0);
            }
          }
        } catch (error) {
          console.error("Failed to load notification count:", error);
        }
      }

      function updateNotificationBadge(count) {
        const badge = document.getElementById("notification-badge");
        if (badge) {
          badge.textContent = count;
          // Hide badge if count is 0
          if (count === 0) {
            badge.style.display = "none";
          } else {
            badge.style.display = "inline";
          }
          console.log(`Notification badge updated: ${count}`);
        }
      }

      async function loadNotifications() {
        try {
          const response = await fetch("/api/notifications?limit=10", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            updateNotificationsList(data.notifications);
          }
        } catch (error) {
          console.error("Failed to load notifications:", error);
        }
      }

      function updateNotificationsList(notifications) {
        const container = document.getElementById("notifications-list");
        if (!container) return;

        if (!notifications || notifications.length === 0) {
          container.innerHTML = `
            <div class="text-center text-muted py-3">
              <i class="bi bi-bell-slash fs-4"></i>
              <p class="mb-0">No notifications</p>
            </div>
          `;
          return;
        }

        let html = "";
        notifications.forEach((notification) => {
          const unreadClass = notification.read ? "" : "unread";
          const timestamp = new Date(notification.timestamp).toLocaleString();

          html += `
            <div class="notification-item ${unreadClass}" onclick="markNotificationRead(${notification.id})">
              <div class="notification-message">${notification.message}</div>
              <div class="notification-meta">
                <span class="notification-type ${notification.type}">${notification.type}</span>
                <span>${timestamp}</span>
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      async function markNotificationRead(notificationId) {
        try {
          const response = await fetch(
            `/api/notifications/${notificationId}/read`,
            {
              method: "POST",
              credentials: "include",
            }
          );

          if (response.ok) {
            // Reload notifications and count
            loadNotificationCount();
            loadNotifications();
          }
        } catch (error) {
          console.error("Failed to mark notification as read:", error);
        }
      }

      async function markAllNotificationsRead() {
        try {
          const response = await fetch("/api/notifications", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            // Mark all unread notifications as read
            const unreadNotifications = data.notifications.filter(
              (n) => !n.read
            );

            for (const notification of unreadNotifications) {
              await markNotificationRead(notification.id);
            }
          }
        } catch (error) {
          console.error("Failed to mark all notifications as read:", error);
        }
      }

      function initializeSocketIO() {
        console.log("🔌 Initializing Socket.IO connection...");

        // Initialize Socket.IO connection
        socket = io();

        socket.on("connect", function () {
          console.log("✅ Connected to Socket.IO server");
          console.log("   Socket ID:", socket.id);
          // Join admin room
          console.log("   Joining admin room...");
          socket.emit("join_admin_room");
        });

        socket.on("disconnect", function () {
          console.log("❌ Disconnected from Socket.IO server");
        });

        socket.on("new_notification", function (data) {
          console.log("🔔 New notification received via WebSocket:", data);
          // Update notification count and list
          loadNotificationCount();
          loadNotifications();

          // Show toast notification
          console.log("   Showing toast notification...");
          showToastNotification(data.message, data.type);
        });

        socket.on("connection_status", function (data) {
          console.log("📡 Connection status:", data);
        });

        socket.on("room_joined", function (data) {
          console.log("🚪 Room joined:", data);
          if (data.room === "role_admin" && data.status === "success") {
            console.log(
              "   ✅ Successfully joined admin room - ready for notifications!"
            );
          } else {
            console.log("   ❌ Failed to join admin room");
          }
        });

        socket.on("connect_error", function (error) {
          console.error("❌ Socket.IO connection error:", error);
        });

        socket.on("error", function (error) {
          console.error("❌ Socket.IO error:", error);
        });
      }

      function showToastNotification(message, type) {
        console.log("🍞 Creating toast notification:", { message, type });

        // Create a simple toast notification
        const toast = document.createElement("div");
        toast.className = `alert alert-${
          type === "error" ? "danger" : type
        } alert-dismissible fade show position-fixed`;
        toast.style.cssText =
          "top: 20px; right: 20px; z-index: 9999; min-width: 300px;";
        toast.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(toast);
        console.log("   ✅ Toast notification created and added to DOM");

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
            console.log("   🗑️ Toast notification auto-removed");
          }
        }, 5000);
      }

      // Make functions globally available
      window.showNotificationDropdown = showNotificationDropdown;
      window.hideNotificationDropdown = hideNotificationDropdown;
      window.loadNotificationCount = loadNotificationCount;
      window.updateNotificationBadge = updateNotificationBadge;
      window.markNotificationRead = markNotificationRead;
      window.markAllNotificationsRead = markAllNotificationsRead;
    </script>

    <!-- JavaScript Files -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation.js') }}"></script>

    {% block scripts %}{% endblock %}
  </body>
</html>
