<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Secure Flask Feedback Application" />
    <title>{% block title %}Feedback App{% endblock %}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link
      href="{{ url_for('static', filename='css/style.css') }}"
      rel="stylesheet"
    />

    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <!-- Navigation -->
    <nav
      class="navbar navbar-expand-lg navbar-modern"
      aria-label="Main navigation"
    >
      <div class="container">
        <a
          class="navbar-brand navbar-brand-modern"
          href="{{ url_for('main.index') }}"
          aria-label="Home"
        >
          <i class="bi bi-chat-dots"></i> Feedback App
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('main.index') }}"
                aria-label="Home page"
              >
                <i class="bi bi-house"></i> Home
              </a>
            </li>
            <li class="nav-item">
              <a
                class="nav-link"
                href="{{ url_for('main.about') }}"
                aria-label="About page"
              >
                <i class="bi bi-info-circle"></i> About
              </a>
            </li>
          </ul>

          <ul class="navbar-nav" id="auth-nav">
            <!-- Auth navigation will be populated by JavaScript -->
          </ul>

          <!-- Notification Bell (for authenticated users) -->
          <div
            class="navbar-nav ms-2"
            id="notification-bell"
            style="display: none; position: relative"
          >
            <!-- Bell Icon Container -->
            <a
              href="#"
              class="nav-link"
              onclick="showNotifications()"
              aria-label="Notifications"
              style="position: relative; padding: 8px"
            >
              <i class="bi bi-bell fs-5"></i>
            </a>

            <!-- Separate Badge Container - Positioned independently like Facebook/Instagram -->
            <div
              id="notification-count"
              style="
                position: absolute;
                top: 0;
                right: 0;
                min-width: 24px;
                height: 24px;
                background-color: #dc3545;
                color: white;
                border-radius: 12px;
                font-size: 12px;
                font-weight: bold;
                display: flex;
                align-items: center;
                justify-content: center;
                border: 2px solid white;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
                z-index: 9999;
                padding: 0 6px;
              "
            >
              0
            </div>
          </div>

          <!-- Dark Mode Toggle -->
          <button
            class="theme-toggle navbar-nav ms-2"
            id="theme-toggle"
            aria-label="Toggle dark mode"
          >
            <i class="bi bi-sun-fill" id="theme-icon"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="container my-4" role="main">
      <!-- Flash Messages -->
      <div id="flash-messages"></div>

      <!-- Page Content -->
      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer
      class="py-4 mt-5"
      role="contentinfo"
      style="
        background-color: var(--bg-secondary);
        border-top: 1px solid var(--border-primary);
      "
    >
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <p class="mb-0" style="color: var(--text-secondary)">
              &copy; 2025 Feedback App. All rights reserved.
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <p class="mb-0">
              <a
                href="{{ url_for('main.about') }}"
                class="text-decoration-none"
                style="color: var(--text-secondary)"
                >About</a
              >
              |
              <a
                href="#"
                class="text-decoration-none"
                style="color: var(--text-secondary)"
                >Privacy</a
              >
              |
              <a
                href="#"
                class="text-decoration-none"
                style="color: var(--text-secondary)"
                >Terms</a
              >
            </p>
          </div>
        </div>
      </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
    <script src="{{ url_for('static', filename='js/validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    {% block extra_js %}{% endblock %}

    <script>
      // Test if scripts are loading
      console.log("Base template script loaded");
      console.log("App available:", typeof App);
      console.log("Auth available:", typeof Auth);

      // Initialize app when DOM is loaded
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, initializing apps...");

        // Initialize App first
        if (typeof App !== "undefined") {
          console.log("Initializing App...");
          App.init();

          // Test theme toggle after initialization
          setTimeout(() => {
            console.log("Testing theme toggle...");
            const themeToggle = document.getElementById("theme-toggle");
            const themeIcon = document.getElementById("theme-icon");
            console.log("Theme toggle found:", !!themeToggle);
            console.log("Theme icon found:", !!themeIcon);
            console.log(
              "Current theme:",
              document.documentElement.getAttribute("data-theme")
            );
          }, 1000);
        } else {
          console.log("App not found!");
        }

        // Initialize Auth after a short delay to ensure everything is loaded
        setTimeout(() => {
          console.log("Timeout reached, checking Auth...");

          if (typeof Auth !== "undefined") {
            console.log("Initializing Auth...");
            Auth.init();
          } else {
            console.log("Auth not found! Check if auth.js is loaded properly.");
            console.log(
              "Available global objects:",
              Object.keys(window).filter(
                (key) => key.includes("Auth") || key.includes("App")
              )
            );
          }

          // Initialize notification bell functionality
          console.log("About to initialize notification bell...");
          initNotificationBell();

          // Also check if bell is visible after a delay
          setTimeout(() => {
            const bell = document.getElementById("notification-bell");
            const badge = document.getElementById("notification-count");
            console.log(
              "After 2 seconds - Bell display:",
              bell ? bell.style.display : "bell not found"
            );
            console.log(
              "After 2 seconds - Badge display:",
              badge ? badge.style.display : "badge not found"
            );
            console.log(
              "After 2 seconds - Badge text:",
              badge ? badge.textContent : "badge not found"
            );
          }, 2000);
        }, 200);
      });

      // Notification Bell Functions
      function initNotificationBell() {
        console.log("Initializing notification bell...");
        // Check if user is authenticated and is admin
        if (typeof Auth !== "undefined" && Auth.isAuthenticated()) {
          // Check if user is admin before showing notification bell
          checkUserRoleAndShowBell();
        }
      }

      async function checkUserRoleAndShowBell() {
        try {
          console.log("Checking user role for notification bell...");
          const response = await fetch("/auth/me", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            console.log("User data:", data);
            if (data.user && data.user.role === "admin") {
              console.log("User is admin, showing notification bell");
              showNotificationBell();
              loadNotificationCount();
              // Store admin status to prevent interference
              window.isAdminUser = true;
            } else {
              console.log("User is not admin, hiding notification bell");
              hideNotificationBell();
              window.isAdminUser = false;
            }
          } else {
            console.log("Failed to get user data, status:", response.status);
          }
        } catch (error) {
          console.error("Failed to check user role:", error);
          hideNotificationBell();
        }
      }

      function showNotificationBell() {
        const notificationBell = document.getElementById("notification-bell");
        if (notificationBell) {
          notificationBell.style.display = "block";
          console.log("Notification bell shown");
          // Also check if badge is visible
          const badge = document.getElementById("notification-count");
          if (badge) {
            console.log("Badge found, display style:", badge.style.display);
            console.log("Badge text content:", badge.textContent);
          } else {
            console.log("Badge not found!");
          }
        } else {
          console.log("Notification bell element not found!");
        }
      }

      function hideNotificationBell() {
        // Don't hide if user is admin
        if (window.isAdminUser) {
          console.log("Not hiding notification bell - user is admin");
          return;
        }

        const notificationBell = document.getElementById("notification-bell");
        if (notificationBell) {
          notificationBell.style.display = "none";
          console.log("Notification bell hidden");
        }
      }

      async function loadNotificationCount() {
        try {
          const response = await fetch("/api/notifications/count", {
            credentials: "include",
          });

          if (response.ok) {
            const data = await response.json();
            if (data.is_admin) {
              updateNotificationBadge(data.unread_count);
            } else {
              // Non-admin users don't see notification count
              updateNotificationBadge(0);
            }
          }
        } catch (error) {
          console.error("Failed to load notification count:", error);
        }
      }

      function updateNotificationBadge(count) {
        const badge = document.getElementById("notification-count");
        if (badge) {
          badge.textContent = count;
          // Always show the badge for admin users, even if count is 0
          badge.style.display = "inline";
          console.log(`Notification badge updated: ${count}`);
        }
      }

      function showNotifications() {
        // Redirect to admin notifications page (admin-only feature)
        if (typeof Auth !== "undefined" && Auth.isAuthenticated()) {
          window.location.href = "/admin/notifications";
        }
      }

      // Make functions globally available
      window.showNotificationBell = showNotificationBell;
      window.hideNotificationBell = hideNotificationBell;
      window.loadNotificationCount = loadNotificationCount;
      window.updateNotificationBadge = updateNotificationBadge;

      // Debug function to test notification bell
      window.testNotificationBell = function () {
        console.log("Testing notification bell...");
        showNotificationBell();
        updateNotificationBadge(5); // Set a test count

        // Make it very obvious for testing
        const bell = document.getElementById("notification-bell");
        if (bell) {
          bell.style.backgroundColor = "yellow";
          bell.style.border = "3px solid red";
          bell.style.padding = "10px";
        }

        // Also make the badge very obvious
        const badge = document.getElementById("notification-count");
        if (badge) {
          badge.style.backgroundColor = "red";
          badge.style.color = "white";
          badge.style.border = "3px solid yellow";
          badge.style.fontSize = "14px";
          badge.style.fontWeight = "bold";
        }

        console.log(
          "Notification bell should now be visible with count 5 and bright yellow background"
        );
        console.log("Badge should be bright lime green with blue border");
      };
    </script>
  </body>
</html>
