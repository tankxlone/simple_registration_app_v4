{% extends "base.html" %} {% block title %}Manage Users - Admin{% endblock %} {%
block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="admin-header">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="h3 mb-2"><i class="bi bi-people"></i> Manage Users</h1>
            <p class="mb-0">
              View, edit, and manage user accounts and permissions.
            </p>
          </div>
          <div class="col-md-4 text-md-end">
            <div class="display-4">
              <i class="bi bi-person-gear"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User Management Tools -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="admin-tools">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="search-container">
              <input
                type="text"
                class="form-control"
                id="search-users"
                placeholder="Search users by name or email..."
              />
            </div>
          </div>
          <div class="col-md-6 text-md-end">
            <button class="btn btn-success" onclick="exportUsers()">
              <i class="bi bi-download"></i> Export Users
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Users Table -->
  <div class="row">
    <div class="col-12">
      <div class="admin-table-card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-table"></i> User Accounts</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table admin-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Joined</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="users-table-body">
                <tr>
                  <td colspan="6" class="text-center text-muted">
                    Loading users...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <nav aria-label="Users pagination">
            <ul
              class="pagination pagination-modern justify-content-center"
              id="users-pagination"
            ></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div
  class="modal fade"
  id="editUserModal"
  tabindex="-1"
  aria-labelledby="editUserModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="edit-user-form">
          <input type="hidden" id="edit-user-id" />
          <div class="mb-3">
            <label for="edit-user-name" class="form-label">Name</label>
            <input
              type="text"
              class="form-control"
              id="edit-user-name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="edit-user-email" class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              id="edit-user-email"
              readonly
            />
          </div>
          <div class="mb-3">
            <label for="edit-user-role" class="form-label">Role</label>
            <select class="form-select" id="edit-user-role" required>
              <option value="user">User</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="edit-user-status" class="form-label">Status</label>
            <select class="form-select" id="edit-user-status" required>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveUserChanges()"
        >
          Save Changes
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let currentPage = 1;
  const usersPerPage = 10;

  document.addEventListener("DOMContentLoaded", function () {
    loadUsers();

    // Search functionality
    document
      .getElementById("search-users")
      .addEventListener("input", function () {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          searchUsers();
        }, 500);
      });
  });

  async function loadUsers(page = 1, search = '') {
    try {
      App.showLoading();

      const searchParam = search ? `&search=${encodeURIComponent(search)}` : '';
      const response = await fetch(
        `/admin/api/users?page=${page}&per_page=${usersPerPage}${searchParam}`,
        {
          credentials: "include",
        }
      );

      if (response.ok) {
        const data = await response.json();
        displayUsers(data.users || []);
        setupPagination(data.total || 0, page);
      } else {
        App.showFlashMessage("Failed to load users", "danger");
      }
    } catch (error) {
      console.error("Failed to load users:", error);
      App.showFlashMessage("An error occurred while loading users", "danger");
    } finally {
      App.hideLoading();
    }
  }

  function displayUsers(users) {
    const tbody = document.getElementById("users-table-body");

    if (users.length === 0) {
      tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted">
                    No users found
                </td>
            </tr>
        `;
      return;
    }

    const html = users
      .map(
        (user) => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <i class="bi bi-person-circle text-primary fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0">${user.name}</h6>
                        <small class="text-muted">ID: ${user.id}</small>
                    </div>
                </div>
            </td>
            <td>${user.email}</td>
            <td>
                <span class="badge bg-${
                  user.role === "admin" ? "danger" : "primary"
                }">
                    ${user.role}
                </span>
            </td>
            <td>
                <span class="badge bg-${
                  user.is_active ? "success" : "primary"
                }">
                    ${user.is_active ? "Active" : "Inactive"}
                </span>
            </td>
            <td>${new Date(user.created_at).toLocaleDateString()}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline" onclick="editUser(${
                      user.id
                    })">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-outline" onclick="toggleUserStatus(${
                      user.id
                    }, ${user.is_active})">
                        <i class="bi bi-${
                          user.is_active ? "pause" : "play"
                        }"></i>
                    </button>
                </div>
            </td>
        </tr>
    `
      )
      .join("");

    tbody.innerHTML = html;
  }

  function setupPagination(total, currentPage) {
    const pagination = document.getElementById("users-pagination");
    const totalPages = Math.ceil(total / usersPerPage);

    if (totalPages <= 1) {
      pagination.innerHTML = "";
      return;
    }

    let html = "";

    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="loadUsers(${
              currentPage - 1
            })">Previous</a>
        </li>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
      if (i === currentPage) {
        html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
      } else {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadUsers(${i})">${i}</a></li>`;
      }
    }

    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="loadUsers(${
              currentPage + 1
            })">Next</a>
        </li>
    `;

    pagination.innerHTML = html;
  }

  function searchUsers() {
    const searchTerm = document.getElementById("search-users").value.trim();
    currentPage = 1; // Reset to first page when searching
    loadUsers(1, searchTerm);
  }

  // Add event listener for search input
  document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-users');
    if (searchInput) {
      // Search on input with debouncing
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchUsers();
        }, 300); // Wait 300ms after user stops typing
      });
      
      // Also search on Enter key
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchUsers();
        }
      });
    }
  });

  async function editUser(userId) {
    try {
      const response = await fetch(`/admin/users/${userId}`, {
        credentials: "include",
      });

      if (response.ok) {
        const user = await response.json();

        document.getElementById("edit-user-id").value = user.id;
        document.getElementById("edit-user-name").value = user.name;
        document.getElementById("edit-user-email").value = user.email;
        document.getElementById("edit-user-role").value = user.role;
        document.getElementById("edit-user-status").value = user.is_active
          ? "active"
          : "inactive";

        const modal = new bootstrap.Modal(
          document.getElementById("editUserModal")
        );
        modal.show();
      } else {
        App.showFlashMessage("Failed to load user details", "danger");
      }
    } catch (error) {
      console.error("Failed to load user details:", error);
      App.showFlashMessage(
        "An error occurred while loading user details",
        "danger"
      );
    }
  }

  async function saveUserChanges() {
    try {
      const userId = document.getElementById("edit-user-id").value;
      const formData = {
        name: document.getElementById("edit-user-name").value,
        role: document.getElementById("edit-user-role").value,
        is_active:
          document.getElementById("edit-user-status").value === "active",
      };

      const response = await fetch(`/admin/users/${userId}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
        credentials: "include",
      });

      if (response.ok) {
        App.showFlashMessage("User updated successfully!", "success");
        bootstrap.Modal.getInstance(
          document.getElementById("editUserModal")
        ).hide();
        loadUsers(currentPage);
      } else {
        const data = await response.json();
        App.showFlashMessage(data.error || "Failed to update user", "danger");
      }
    } catch (error) {
      console.error("Failed to update user:", error);
      App.showFlashMessage("An error occurred while updating user", "danger");
    }
  }

  async function toggleUserStatus(userId, currentStatus) {
    try {
      const response = await fetch(`/admin/users/${userId}/toggle-status`, {
        method: "POST",
        credentials: "include",
      });

      if (response.ok) {
        App.showFlashMessage(
          `User ${currentStatus ? "deactivated" : "activated"} successfully!`,
          "success"
        );
        loadUsers(currentPage);
      } else {
        const data = await response.json();
        App.showFlashMessage(
          data.error || "Failed to toggle user status",
          "danger"
        );
      }
    } catch (error) {
      console.error("Failed to toggle user status:", error);
      App.showFlashMessage(
        "An error occurred while toggling user status",
        "danger"
      );
    }
  }

  async function exportUsers() {
    try {
      App.showLoading();

      const response = await fetch("/admin/export-users", {
        credentials: "include",
      });

      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "users_data.csv";
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        App.showFlashMessage("Users data exported successfully!", "success");
      } else {
        const data = await response.json();
        App.showFlashMessage(
          data.error || "Failed to export users data",
          "danger"
        );
      }
    } catch (error) {
      console.error("Export error:", error);
      App.showFlashMessage(
        "An error occurred while exporting users data",
        "danger"
      );
    } finally {
      App.hideLoading();
    }
  }
</script>
{% endblock %}
