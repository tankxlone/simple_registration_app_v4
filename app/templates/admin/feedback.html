{% extends "base.html" %} {% block title %}Manage Feedback - Admin{% endblock %}
{% block content %}
<div class="container-fluid">
  <!-- Page Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="admin-header">
        <div class="row align-items-center">
          <div class="col-md-8">
            <h1 class="h3 mb-2">
              <i class="bi bi-chat-square-text"></i> Manage Feedback
            </h1>
            <p class="mb-0">
              Review, moderate, and correct sentiment analysis results.
            </p>
          </div>
          <div class="col-md-4 text-md-end">
            <div class="display-4">
              <i class="bi bi-chat-dots"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Management Tools -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="admin-tools">
        <div class="row align-items-center">
          <div class="col-md-4">
            <div class="search-container">
              <input
                type="text"
                class="form-control"
                id="search-feedback"
                placeholder="Search feedback..."
              />
            </div>
          </div>
          <div class="col-md-4">
            <select
              class="form-select"
              id="sentiment-filter"
              onchange="filterBySentiment()"
            >
              <option value="">All Sentiments</option>
              <option value="positive">Positive</option>
              <option value="negative">Negative</option>
              <option value="neutral">Neutral</option>
            </select>
          </div>
          <div class="col-md-4 text-md-end">
            <button class="btn btn-primary" onclick="exportFeedback()">
              <i class="bi bi-download"></i> Export Feedback
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Feedback Table -->
  <div class="row">
    <div class="col-12">
      <div class="admin-table-card">
        <div class="card-header">
          <h5 class="mb-0"><i class="bi bi-table"></i> Feedback Entries</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table admin-table">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Feedback</th>
                  <th>Rating</th>
                  <th>AI Sentiment</th>
                  <th>Corrected Sentiment</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="feedback-table-body">
                <tr>
                  <td colspan="7" class="text-center text-muted">
                    Loading feedback...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <nav aria-label="Feedback pagination">
            <ul
              class="pagination pagination-modern justify-content-center"
              id="feedback-pagination"
            ></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Sentiment Modal -->
<div
  class="modal fade"
  id="editSentimentModal"
  tabindex="-1"
  aria-labelledby="editSentimentModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editSentimentModalLabel">
          Correct Sentiment Analysis
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form id="edit-sentiment-form">
          <input type="hidden" id="edit-feedback-id" />
          <div class="mb-3">
            <label class="form-label">Feedback Text</label>
            <div class="form-control-plaintext" id="edit-feedback-text"></div>
          </div>
          <div class="mb-3">
            <label class="form-label">AI Sentiment</label>
            <div class="form-control-plaintext" id="edit-ai-sentiment"></div>
          </div>
          <div class="mb-3">
            <label for="edit-corrected-sentiment" class="form-label"
              >Corrected Sentiment</label
            >
            <select class="form-select" id="edit-corrected-sentiment" required>
              <option value="positive">Positive</option>
              <option value="negative">Negative</option>
              <option value="neutral">Neutral</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="edit-confidence" class="form-label"
              >Confidence (0-1)</label
            >
            <input
              type="number"
              class="form-control"
              id="edit-confidence"
              min="0"
              max="1"
              step="0.1"
              value="1.0"
              required
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          onclick="saveSentimentCorrection()"
        >
          Save Correction
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  let currentPage = 1;
  const feedbackPerPage = 10;

  document.addEventListener("DOMContentLoaded", function () {
    loadFeedback();

    // Search functionality
    document
      .getElementById("search-feedback")
      .addEventListener("input", function () {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          searchFeedback();
        }, 500);
      });
  });

  async function loadFeedback(page = 1) {
    try {
      App.showLoading();

      const response = await fetch(
        `/admin/api/feedback?page=${page}&per_page=${feedbackPerPage}`,
        {
          credentials: "include",
        }
      );

      if (response.ok) {
        const data = await response.json();
        displayFeedback(data.feedback || []);
        setupPagination(data.total || 0, page);
      } else {
        App.showFlashMessage("Failed to load feedback", "danger");
      }
    } catch (error) {
      console.error("Failed to load feedback:", error);
      App.showFlashMessage(
        "An error occurred while loading feedback",
        "danger"
      );
    } finally {
      App.hideLoading();
    }
  }

  function displayFeedback(feedback) {
    const tbody = document.getElementById("feedback-table-body");

    if (feedback.length === 0) {
      tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    No feedback found
                </td>
            </tr>
        `;
      return;
    }

    const html = feedback
      .map(
        (item) => `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="flex-shrink-0 me-3">
                        <i class="bi bi-person-circle text-primary fs-4"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-0">${item.user_name}</h6>
                        <small class="text-muted">${item.user_email}</small>
                    </div>
                </div>
            </td>
            <td>
                <div class="text-truncate" style="max-width: 200px;" title="${
                  item.text
                }">
                    ${item.text}
                </div>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    ${generateRatingStars(item.rating)}
                    <span class="ms-2">${item.rating}/5</span>
                </div>
            </td>
            <td>
                <span class="badge bg-${getSentimentColor(
                  item.sentiment
                )}">
                    ${item.sentiment}
                </span>
                <br>
                <small class="text-muted">${(item.confidence * 100).toFixed(
                  1
                )}%</small>
            </td>
            <td>
                ${
                  item.admin_corrected_label
                    ? `<span class="badge bg-${getSentimentColor(
                        item.admin_corrected_label
                      )}">
                        ${item.admin_corrected_label}
                    </span>`
                    : '<span class="text-muted">Not corrected</span>'
                }
            </td>
            <td>${new Date(item.created_at).toLocaleDateString()}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline" onclick="editSentiment(${
                      item.id
                    })">
                        <i class="bi bi-pencil"></i> Correct
                    </button>
                    <button class="btn btn-outline" onclick="deleteFeedback(${
                      item.id
                    })">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `
      )
      .join("");

    tbody.innerHTML = html;
  }

  function generateRatingStars(rating) {
    let stars = "";
    for (let i = 1; i <= 5; i++) {
      if (i <= rating) {
        stars += '<i class="bi bi-star-fill text-warning"></i>';
      } else {
        stars += '<i class="bi bi-star text-muted"></i>';
      }
    }
    return stars;
  }

  function getSentimentColor(sentiment) {
    switch (sentiment) {
      case "positive":
        return "success";
      case "negative":
        return "danger";
      case "neutral":
        return "secondary";
      default:
        return "secondary";
    }
  }

  function setupPagination(total, currentPage) {
    const pagination = document.getElementById("feedback-pagination");
    const totalPages = Math.ceil(total / feedbackPerPage);

    if (totalPages <= 1) {
      pagination.innerHTML = "";
      return;
    }

    let html = "";

    // Previous button
    html += `
        <li class="page-item ${currentPage === 1 ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="loadFeedback(${
              currentPage - 1
            })">Previous</a>
        </li>
    `;

    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
      if (i === currentPage) {
        html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
      } else {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadFeedback(${i})">${i}</a></li>`;
      }
    }

    // Next button
    html += `
        <li class="page-item ${currentPage === totalPages ? "disabled" : ""}">
            <a class="page-link" href="#" onclick="loadFeedback(${
              currentPage + 1
            })">Next</a>
        </li>
    `;

    pagination.innerHTML = html;
  }

  function searchFeedback() {
    const searchTerm = document.getElementById("search-feedback").value.trim();
    if (searchTerm) {
      // Implement search functionality
      loadFeedback(1);
    } else {
      loadFeedback(1);
    }
  }

  function filterBySentiment() {
    const sentiment = document.getElementById("sentiment-filter").value;
    if (sentiment) {
      // Implement sentiment filtering
      loadFeedback(1);
    } else {
      loadFeedback(1);
    }
  }

  async function editSentiment(feedbackId) {
    try {
      const response = await fetch(`/admin/feedback/${feedbackId}`, {
        credentials: "include",
      });

      if (response.ok) {
        const feedback = await response.json();

        document.getElementById("edit-feedback-id").value = feedback.id;
        document.getElementById("edit-feedback-text").textContent =
          feedback.text;
        document.getElementById("edit-ai-sentiment").textContent = `${
          feedback.sentiment_label
        } (${(feedback.confidence * 100).toFixed(1)}%)`;
        document.getElementById("edit-corrected-sentiment").value =
          feedback.corrected_sentiment || feedback.sentiment_label;
        document.getElementById("edit-confidence").value =
          feedback.corrected_confidence || feedback.confidence;

        const modal = new bootstrap.Modal(
          document.getElementById("editSentimentModal")
        );
        modal.show();
      } else {
        App.showFlashMessage("Failed to load feedback details", "danger");
      }
    } catch (error) {
      console.error("Failed to load feedback details:", error);
      App.showFlashMessage(
        "An error occurred while loading feedback details",
        "danger"
      );
    }
  }

  async function saveSentimentCorrection() {
    try {
      const feedbackId = document.getElementById("edit-feedback-id").value;
      const formData = {
        corrected_sentiment: document.getElementById("edit-corrected-sentiment")
          .value,
        corrected_confidence: parseFloat(
          document.getElementById("edit-confidence").value
        ),
      };

      const response = await fetch(`/admin/feedback/${feedbackId}/correct`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
        credentials: "include",
      });

      if (response.ok) {
        App.showFlashMessage(
          "Sentiment correction saved successfully!",
          "success"
        );
        bootstrap.Modal.getInstance(
          document.getElementById("editSentimentModal")
        ).hide();
        loadFeedback(currentPage);
      } else {
        const data = await response.json();
        App.showFlashMessage(
          data.error || "Failed to save sentiment correction",
          "danger"
        );
      }
    } catch (error) {
      console.error("Failed to save sentiment correction:", error);
      App.showFlashMessage(
        "An error occurred while saving sentiment correction",
        "danger"
      );
    }
  }

  async function deleteFeedback(feedbackId) {
    if (
      !confirm(
        "Are you sure you want to delete this feedback? This action cannot be undone."
      )
    ) {
      return;
    }

    try {
      const response = await fetch(`/admin/feedback/${feedbackId}`, {
        method: "DELETE",
        credentials: "include",
      });

      if (response.ok) {
        App.showFlashMessage("Feedback deleted successfully!", "success");
        loadFeedback(currentPage);
      } else {
        const data = await response.json();
        App.showFlashMessage(
          data.error || "Failed to delete feedback",
          "danger"
        );
      }
    } catch (error) {
      console.error("Failed to delete feedback:", error);
      App.showFlashMessage(
        "An error occurred while deleting feedback",
        "danger"
      );
    }
  }

  async function exportFeedback() {
    try {
      App.showLoading();

      const response = await fetch("/admin/export-feedback", {
        credentials: "include",
      });

      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "feedback_data.csv";
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        App.showFlashMessage("Feedback data exported successfully!", "success");
      } else {
        const data = await response.json();
        App.showFlashMessage(
          data.error || "Failed to export feedback data",
          "danger"
        );
      }
    } catch (error) {
      console.error("Export error:", error);
      App.showFlashMessage(
        "An error occurred while exporting feedback data",
        "danger"
      );
    } finally {
      App.hideLoading();
    }
  }
</script>
{% endblock %}
